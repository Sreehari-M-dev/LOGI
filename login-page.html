<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - LOGI | Digital Lab Logbook System</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Login to LOGI - Digital Lab Logbook Management System. Access your lab experiments, track progress, and manage laboratory documentation.">
    <meta name="keywords" content="LOGI login, lab logbook login, student portal, faculty login, lab management">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://sreehari-m-dev.github.io/LOGI/login-page.html">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Login - LOGI Digital Lab Logbook">
    <meta property="og:description" content="Access your lab experiments and documentation with LOGI.">
    <meta property="og:url" content="https://sreehari-m-dev.github.io/LOGI/login-page.html">
    <meta property="og:image" content="https://sreehari-m-dev.github.io/LOGI/c-logo.png">
    
    <script>
        // Auto-detect environment: use local servers for localhost/local IPs, Render for production
        (function() {
            const hostname = window.location.hostname;
            const isLocal = ['localhost', '127.0.0.1', '10.154.126.1'].includes(hostname) || hostname.startsWith('192.168.');
            if (isLocal) {
                // Use the same hostname/IP for local servers so it works from remote IPs too
                const host = hostname === 'localhost' ? 'localhost' : hostname;
                window.REACT_APP_AUTH_API = `http://${host}:3002/api/auth`;
                window.REACT_APP_LOGBOOK_API = `http://${host}:3005/api/logbook`;
            } else {
                window.REACT_APP_AUTH_API = 'https://logi-auth-service-avbs.onrender.com/api/auth';
                window.REACT_APP_LOGBOOK_API = 'https://logi-logbook-service-avbs.onrender.com/api/logbook';
            }
        })();
    </script>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(circle at 20% 20%, rgba(102, 126, 234, 0.18), transparent 30%),
                        radial-gradient(circle at 80% 0%, rgba(76, 201, 240, 0.2), transparent 28%),
                        linear-gradient(135deg, #0f172a 0%, #0b2b2d 40%, #0c4335 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px;
            color: #0b1d1f;
        }        
        .auth-shell {
            width: 100%;
            max-width: 1100px;
            display: grid;
            grid-template-columns: 1.05fr 0.95fr;
            gap: 32px;
            align-items: center;
            position: relative;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            overflow: hidden;
        }

        .hero-panel {
            position: relative;
            padding: 48px 44px;
            color: #0e1f1f;
            background: linear-gradient(145deg, #d7f7ec 0%, #eaf3ff 40%, #d6e5ff 100%);
            min-height: 520px;
        }

        .hero-kicker {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: rgba(12, 67, 53, 0.08);
            color: #0b4335;
            border-radius: 999px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .hero-title {
            margin: 18px 0 10px;
            font-size: 34px;
            font-weight: 700;
            color: #0e1f1f;
            line-height: 1.2;
        }

        .hero-sub {
            color: #244a4b;
            font-size: 16px;
            max-width: 460px;
            line-height: 1.6;
        }

        .hero-figure {
            margin-top: 28px;
            background: linear-gradient(135deg, #0b4335 0%, #0f5f5a 60%, #0b1d1f 100%);
            border-radius: 18px;
            padding: 28px;
            position: relative;
            overflow: hidden;
            min-height: 280px;
        }

        .hero-figure svg {
            width: 100%;
            height: 240px;
            display: block;
        }

        .hero-badge {
            position: absolute;
            top: 18px;
            right: 18px;
            background: rgba(255, 255, 255, 0.9);
            color: #0b4335;
            padding: 10px 14px;
            border-radius: 14px;
            font-weight: 700;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        }

        .login-panel {
            padding: 44px 42px;
            max-width: 520px;
            margin-left: auto;
        }

        .login-header {
            text-align: left;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #0f4335;
            font-size: 30px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: 0.3px;
        }
        
        .login-header p {
            color: #516164;
            font-size: 15px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #1b2a2c;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e6eef0;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.25s ease;
            font-family: inherit;
            background: #f9fbfc;
            text-align: center;
            letter-spacing: normal;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #36ba86;
            box-shadow: 0 0 0 4px rgba(54, 186, 134, 0.15);
            background: #fff;
        }
        
        .form-group input::placeholder {
            color: #9aa9ad;
        }
        
        .password-toggle {
            position: relative;
        }
        
        .password-toggle-icon {
            position: absolute;
            right: 14px;
            top: 44px;
            cursor: pointer;
            color: #6b7c80;
            transition: color 0.25s ease;
        }
        
        .password-toggle-icon:hover {
            color: #0f4335;
        }
        
        .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(120deg, #36ba86 0%, #1fb5a3 60%, #1e8f71 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 6px;
            box-shadow: 0 12px 28px rgba(31, 181, 163, 0.35);
        }
        
        .submit-btn:hover {
            transform: translateY(-1px) scale(1.005);
            box-shadow: 0 14px 30px rgba(31, 181, 163, 0.45);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .form-footer {
            text-align: left;
            margin-top: 12px;
            font-size: 14px;
            color: #607274;
        }
        
        .form-footer a {
            color: #0f7f61;
            text-decoration: none;
            font-weight: 600;
        }
        
        .form-footer a:hover {
            text-decoration: underline;
        }
        
        .error-message {
            background: #ffecec;
            color: #c0392b;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 18px;
            display: none;
            font-size: 14px;
            border: 1px solid #ffd1d1;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #0f7f61;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e0e0e0;
            border-top-color: #0f7f61;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 2FA Section Styles */
        .twofa-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .twofa-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .twofa-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .twofa-header .icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #36ba86 0%, #1fb5a3 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 28px;
            color: white;
            box-shadow: 0 10px 30px rgba(54, 186, 134, 0.3);
        }
        
        .twofa-header h2 {
            color: #0f4335;
            font-size: 22px;
            margin-bottom: 8px;
        }
        
        .twofa-header p {
            color: #607274;
            font-size: 14px;
        }
        
        .twofa-input {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .twofa-input input {
            width: 48px;
            height: 56px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            border: 2px solid #e6eef0;
            border-radius: 12px;
            background: #f9fbfc;
            transition: all 0.25s ease;
        }
        
        .twofa-input input:focus {
            outline: none;
            border-color: #36ba86;
            box-shadow: 0 0 0 4px rgba(54, 186, 134, 0.15);
            background: #fff;
        }
        
        /* Backup Code Input Styles */
        .backup-code-input {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .backup-code-input input {
            width: 40px;
            height: 48px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            border: 2px solid #e6eef0;
            border-radius: 10px;
            background: #f9fbfc;
            transition: all 0.25s ease;
            text-transform: uppercase;
        }
        
        .backup-code-input input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
            background: #fff;
        }
        
        .backup-code-input input.filled {
            border-color: #36ba86;
            background: rgba(54, 186, 134, 0.05);
        }
        
        .back-to-login {
            text-align: center;
            margin-top: 16px;
        }
        
        .back-to-login a {
            color: #607274;
            text-decoration: none;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }
        
        .back-to-login a:hover {
            color: #0f4335;
        }
        
        /* Responsive Styles */
        @media (max-width: 992px) {
            .auth-shell {
                grid-template-columns: 1fr;
                max-width: 550px;
                gap: 24px;
            }
            
            .hero-panel {
                min-height: auto;
                padding: 36px 32px;
            }
            
            .hero-figure {
                min-height: 220px;
            }
            
            .hero-figure svg {
                height: 200px;
            }
            
            .login-panel {
                padding: 36px 32px;
                margin-left: 0;
            }
        }
        
        @media (max-width: 600px) {
            body {
                padding: 16px;
            }
            
            .auth-shell {
                gap: 16px;
            }
            
            .hero-panel {
                padding: 28px 20px;
            }
            
            .hero-kicker {
                font-size: 13px;
                padding: 8px 12px;
            }
            
            .hero-title {
                font-size: 26px;
                margin: 14px 0 8px;
            }
            
            .hero-sub {
                font-size: 14px;
            }
            
            .hero-figure {
                margin-top: 20px;
                padding: 20px;
                min-height: 180px;
            }
            
            .hero-figure svg {
                height: 160px;
            }
            
            .hero-badge {
                padding: 8px 10px;
                font-size: 12px;
                top: 12px;
                right: 12px;
            }
            
            .login-panel {
                padding: 28px 20px;
            }
            
            .login-header h1 {
                font-size: 24px;
            }
            
            .login-header p {
                font-size: 14px;
            }
            
            .form-group label {
                font-size: 13px;
            }
            
            .form-group input {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .submit-btn {
                padding: 12px;
                font-size: 15px;
            }
            
            .form-footer {
                font-size: 13px;
            }
        }
        
        @media (max-width: 400px) {
            body {
                padding: 10px;
            }
            
            .hero-panel {
                padding: 20px 15px;
            }
            
            .hero-title {
                font-size: 22px;
            }
            
            .hero-sub {
                font-size: 13px;
            }
            
            .hero-figure {
                padding: 15px;
                min-height: 150px;
            }
            
            .hero-figure svg {
                height: 130px;
            }
            
            .login-panel {
                padding: 20px 15px;
            }
            
            .login-header h1 {
                font-size: 20px;
            }
            
            .glass-card {
                border-radius: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="auth-shell">
        <div class="glass-card hero-panel">
            <div class="hero-kicker"><i class="fas fa-seedling"></i> Digital Lab Portal</div>
            <div class="hero-title">Welcome back to LOGI</div>
            <p class="hero-sub">Track experiments, sync logbooks, and collaborate with faculty in a refreshed, modern workspace.</p>
            <div class="hero-figure">
                <div class="hero-badge"><i class="fas fa-shield-heart"></i> Secure Access</div>
                <svg viewBox="0 0 420 260" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <defs>
                        <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#34d399"/>
                            <stop offset="100%" stop-color="#0ea5e9"/>
                        </linearGradient>
                        <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#0ea5e9" stop-opacity="0.9"/>
                            <stop offset="100%" stop-color="#7c3aed" stop-opacity="0.85"/>
                        </linearGradient>
                    </defs>
                    <path d="M30 210 Q110 120 220 190 T390 170" fill="none" stroke="#8be9d0" stroke-width="12" stroke-linecap="round" stroke-dasharray="10 16" opacity="0.7"/>
                    <rect x="82" y="62" rx="16" ry="16" width="180" height="120" fill="#0b1d1f" stroke="#63f3c3" stroke-width="3" opacity="0.9"/>
                    <rect x="95" y="78" rx="10" ry="10" width="80" height="20" fill="#0ea5e9" opacity="0.85"/>
                    <rect x="95" y="108" rx="10" ry="10" width="120" height="20" fill="#22d3ee" opacity="0.75"/>
                    <rect x="95" y="138" rx="10" ry="10" width="150" height="20" fill="#34d399" opacity="0.8"/>
                    <circle cx="280" cy="112" r="48" fill="url(#grad1)" opacity="0.95"/>
                    <path d="M260 112 l18 18 32-36" fill="none" stroke="#0b1d1f" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="330" cy="70" r="18" fill="url(#grad2)" opacity="0.9"/>
                    <path d="M328 66 v8 m4-4 h-8" stroke="#0b1d1f" stroke-width="4" stroke-linecap="round"/>
                </svg>
            </div>
        </div>

        <div class="glass-card login-panel">
            <div class="login-header">
                <h1><i class="fas fa-lock"></i> Login</h1>
                <p>Sign in to manage your logbooks</p>
            </div>
            
            <div id="loginError" class="error-message"></div>
            
            <!-- Login Form Section -->
            <div id="loginFormSection">
                <form onsubmit="handleLogin(event)" autocomplete="off">
                    <div class="form-group">
                        <label for="loginRgno"><i class="fas fa-id-card"></i> Register Number</label>
                        <input type="number" id="loginRgno" name="rgno" placeholder="Enter your register number" required autofocus autocomplete="off">
                    </div>
                    
                    <div class="form-group password-toggle">
                        <label for="loginPassword"><i class="fas fa-lock"></i> Password</label>
                        <input type="password" id="loginPassword" name="password" placeholder="Enter your password" required autocomplete="new-password">
                        <span class="password-toggle-icon" onclick="togglePasswordVisibility('loginPassword')">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    
                    <!-- Stay Logged In Checkbox -->
                    <div class="form-group" style="margin: 12px 0;">
                        <label class="stay-logged-in-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 400;">
                            <input type="checkbox" id="stayLoggedIn" name="stayLoggedIn" style="width: 18px; height: 18px; cursor: pointer;" onchange="toggleStayLoggedInWarning()">
                            <span style="font-size: 14px;">Stay logged in on this device</span>
                        </label>
                        <div id="stayLoggedInWarning" style="display: none; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 10px 12px; margin-top: 8px; font-size: 13px; color: #856404;">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 6px;"></i>
                            <strong>Note:</strong> Your session will remain active for up to 7 days without inactivity timeout. After 7 days, you'll need to log in again. Use only on trusted personal devices.
                        </div>
                    </div>
                    
                    <!-- Remaining Attempts Warning -->
                    <div id="remainingAttemptsWarning" style="display: none; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 10px 12px; margin-bottom: 12px; font-size: 13px; color: #721c24;">
                        <i class="fas fa-exclamation-circle" style="margin-right: 6px;"></i>
                        <span id="remainingAttemptsText"></span>
                    </div>
                    
                    <div class="loading" id="loginLoading">
                        <span class="spinner"></span> Logging in...
                    </div>
                    
                    <button type="submit" class="submit-btn" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </form>
                <div class="form-footer" style="margin-top:12px;">
                    <a href="forgot-password.html">Forgot Password?</a>
                </div>
                <div class="form-footer" style="margin-top:8px;">
                    Don't have an account? <a href="register.html">Register here</a>
                </div>
            </div>
            
            <!-- 2FA Verification Section -->
            <div id="twofaSection" class="twofa-section">
                <div class="twofa-header">
                    <div class="icon"><i class="fas fa-shield-halved"></i></div>
                    <h2>Two-Factor Authentication</h2>
                    <p id="twofaPrompt">Enter the 6-digit code from your authenticator app</p>
                </div>
                
                <!-- Authenticator Code Input -->
                <div id="authCodeSection">
                    <div class="twofa-input">
                        <input type="text" maxlength="1" class="twofa-digit" data-index="0" inputmode="numeric" pattern="[0-9]">
                        <input type="text" maxlength="1" class="twofa-digit" data-index="1" inputmode="numeric" pattern="[0-9]">
                        <input type="text" maxlength="1" class="twofa-digit" data-index="2" inputmode="numeric" pattern="[0-9]">
                        <input type="text" maxlength="1" class="twofa-digit" data-index="3" inputmode="numeric" pattern="[0-9]">
                        <input type="text" maxlength="1" class="twofa-digit" data-index="4" inputmode="numeric" pattern="[0-9]">
                        <input type="text" maxlength="1" class="twofa-digit" data-index="5" inputmode="numeric" pattern="[0-9]">
                    </div>
                    
                    <div class="backup-code-link" style="text-align: center; margin-top: 16px;">
                        <a href="#" onclick="showBackupCodeInput(); return false;" style="color: #6366f1; text-decoration: none; font-size: 0.9rem;">
                            <i class="fas fa-key"></i> Use a backup code instead
                        </a>
                    </div>
                </div>
                
                <!-- Backup Code Input (hidden by default) - 8 separate boxes -->
                <div id="backupCodeSection" style="display: none;">
                    <div class="backup-code-input">
                        <input type="text" maxlength="1" class="backup-digit" data-index="0" inputmode="text" autocomplete="off">
                        <input type="text" maxlength="1" class="backup-digit" data-index="1" inputmode="text" autocomplete="off">
                        <input type="text" maxlength="1" class="backup-digit" data-index="2" inputmode="text" autocomplete="off">
                        <input type="text" maxlength="1" class="backup-digit" data-index="3" inputmode="text" autocomplete="off">
                        <input type="text" maxlength="1" class="backup-digit" data-index="4" inputmode="text" autocomplete="off">
                        <input type="text" maxlength="1" class="backup-digit" data-index="5" inputmode="text" autocomplete="off">
                        <input type="text" maxlength="1" class="backup-digit" data-index="6" inputmode="text" autocomplete="off">
                        <input type="text" maxlength="1" class="backup-digit" data-index="7" inputmode="text" autocomplete="off">
                    </div>
                    
                    <div style="text-align: center;">
                        <a href="#" onclick="showAuthCodeInput(); return false;" style="color: #6366f1; text-decoration: none; font-size: 0.9rem;">
                            <i class="fas fa-mobile-alt"></i> Use authenticator app instead
                        </a>
                    </div>
                </div>
                
                <div class="loading" id="twofaLoading">
                    <span class="spinner"></span> Verifying...
                </div>
                
                <button type="button" class="submit-btn" id="verifyTwofaBtn" onclick="verifyTwoFA()">
                    <i class="fas fa-check-circle"></i> Verify Code
                </button>
                
                <div class="back-to-login">
                    <a href="#" onclick="showLoginForm(); return false;">
                        <i class="fas fa-arrow-left"></i> Back to login
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.all.min.js"></script>
    <script>
        const AUTH_API = window.REACT_APP_AUTH_API || 'http://localhost:3002/api/auth';
        
        // Store pending 2FA login credentials
        let pending2FALogin = null;
        
        // Toggle stay logged in warning
        function toggleStayLoggedInWarning() {
            const checkbox = document.getElementById('stayLoggedIn');
            const warning = document.getElementById('stayLoggedInWarning');
            warning.style.display = checkbox.checked ? 'block' : 'none';
        }
        
        // Show remaining attempts warning
        function showRemainingAttempts(remaining) {
            const warningDiv = document.getElementById('remainingAttemptsWarning');
            const textSpan = document.getElementById('remainingAttemptsText');
            
            if (remaining !== undefined && remaining <= 3) {
                textSpan.textContent = `Warning: ${remaining} login attempt${remaining !== 1 ? 's' : ''} remaining before your account is frozen.`;
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        }
        
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = event.target.closest('.password-toggle-icon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                input.type = 'password';
                icon.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }
        
        // Show 2FA section
        function showTwoFASection() {
            document.getElementById('loginFormSection').style.display = 'none';
            document.getElementById('twofaSection').classList.add('active');
            document.getElementById('loginError').style.display = 'none';
            
            // Focus first input
            const firstInput = document.querySelector('.twofa-digit[data-index="0"]');
            if (firstInput) firstInput.focus();
        }
        
        // Show login form
        function showLoginForm() {
            document.getElementById('loginFormSection').style.display = 'block';
            document.getElementById('twofaSection').classList.remove('active');
            pending2FALogin = null;
            
            // Clear 2FA inputs
            document.querySelectorAll('.twofa-digit').forEach(input => input.value = '');
            document.querySelectorAll('.backup-digit').forEach(input => {
                input.value = '';
                input.classList.remove('filled');
            });
            
            // Reset to auth code view
            showAuthCodeInput();
        }
        
        // Show backup code input
        function showBackupCodeInput() {
            document.getElementById('authCodeSection').style.display = 'none';
            document.getElementById('backupCodeSection').style.display = 'block';
            document.getElementById('twofaPrompt').textContent = 'Enter one of your backup codes';
            const firstBackupInput = document.querySelector('.backup-digit[data-index="0"]');
            if (firstBackupInput) firstBackupInput.focus();
        }
        
        // Show authenticator code input
        function showAuthCodeInput() {
            document.getElementById('authCodeSection').style.display = 'block';
            document.getElementById('backupCodeSection').style.display = 'none';
            document.getElementById('twofaPrompt').textContent = 'Enter the 6-digit code from your authenticator app';
            const firstInput = document.querySelector('.twofa-digit[data-index="0"]');
            if (firstInput) firstInput.focus();
        }
        
        // Get backup code from 8 input boxes
        function getBackupCode() {
            let code = '';
            document.querySelectorAll('.backup-digit').forEach(input => {
                code += input.value.toUpperCase();
            });
            return code;
        }
        
        // Setup backup code input handlers
        function setupBackupCodeInputs() {
            const inputs = document.querySelectorAll('.backup-digit');
            
            inputs.forEach((input, index) => {
                // Handle input
                input.addEventListener('input', (e) => {
                    const value = e.target.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                    e.target.value = value;
                    
                    if (value) {
                        e.target.classList.add('filled');
                        // Move to next input
                        if (index < inputs.length - 1) {
                            inputs[index + 1].focus();
                        }
                    } else {
                        e.target.classList.remove('filled');
                    }
                    
                    // Auto-submit when all 8 characters are entered
                    const fullCode = getBackupCode();
                    if (fullCode.length === 8) {
                        verifyTwoFA();
                    }
                });
                
                // Handle backspace
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !input.value && index > 0) {
                        inputs[index - 1].focus();
                        inputs[index - 1].value = '';
                        inputs[index - 1].classList.remove('filled');
                    }
                });
                
                // Handle paste
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pastedData = (e.clipboardData || window.clipboardData).getData('text').replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                    
                    // Fill all inputs starting from the current one
                    for (let i = 0; i < pastedData.length && (index + i) < inputs.length; i++) {
                        inputs[index + i].value = pastedData[i];
                        inputs[index + i].classList.add('filled');
                    }
                    
                    // Focus the next empty input or the last one
                    const nextEmptyIndex = Math.min(index + pastedData.length, inputs.length - 1);
                    inputs[nextEmptyIndex].focus();
                    
                    // Auto-submit if complete
                    const fullCode = getBackupCode();
                    if (fullCode.length === 8) {
                        verifyTwoFA();
                    }
                });
            });
        }
        
        // Get 2FA code from inputs
        function get2FACode() {
            let code = '';
            document.querySelectorAll('.twofa-digit').forEach(input => {
                code += input.value;
            });
            return code;
        }
        
        // Setup 2FA input handlers
        function setup2FAInputs() {
            const inputs = document.querySelectorAll('.twofa-digit');
            
            inputs.forEach((input, index) => {
                // Handle input
                input.addEventListener('input', (e) => {
                    const value = e.target.value.replace(/[^0-9]/g, '');
                    e.target.value = value;
                    
                    if (value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                    
                    // Auto-submit when all filled
                    if (get2FACode().length === 6) {
                        verifyTwoFA();
                    }
                });
                
                // Handle backspace
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
                
                // Handle paste
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);
                    
                    pastedData.split('').forEach((char, i) => {
                        if (inputs[i]) {
                            inputs[i].value = char;
                        }
                    });
                    
                    // Focus last filled or next empty
                    const nextIndex = Math.min(pastedData.length, inputs.length - 1);
                    inputs[nextIndex].focus();
                    
                    // Auto-submit if complete
                    if (pastedData.length === 6) {
                        verifyTwoFA();
                    }
                });
            });
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const rgno = document.getElementById('loginRgno').value;
            const password = document.getElementById('loginPassword').value;
            const stayLoggedIn = document.getElementById('stayLoggedIn').checked;
            const errorDiv = document.getElementById('loginError');
            const loadingDiv = document.getElementById('loginLoading');
            const submitBtn = document.getElementById('loginBtn');
            
            errorDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(`${AUTH_API}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rgno: parseInt(rgno), password, stayLoggedIn })
                });
                
                const result = await response.json();
                
                // Show remaining attempts warning if provided
                if (result.remainingAttempts !== undefined) {
                    showRemainingAttempts(result.remainingAttempts);
                }
                
                // Handle frozen account
                if (result.accountFrozen) {
                    Swal.fire({
                        title: 'Account Frozen',
                        html: `<p style="color: #721c24;">${result.error}</p>`,
                        icon: 'error',
                        confirmButtonColor: '#dc3545'
                    });
                    errorDiv.textContent = result.error;
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Handle email not verified - Email service disabled, contact admin
                if (result.emailNotVerified) {
                    Swal.fire({
                        title: 'üìß Email Not Verified',
                        html: `
                            <p>Your email address needs to be verified before you can log in.</p>
                            <p style="margin-top: 10px;">Email on file:<br>
                            <strong>${result.email || 'your email'}</strong></p>
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #ffc107;">
                                <p style="color: #856404; margin: 0;"><strong>üìû Contact your administrator</strong><br>
                                (Faculty or Principal) to verify your email.</p>
                            </div>
                        `,
                        icon: 'warning',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#667eea'
                    });
                    return;
                }
                
                if (result.success) {
                    // Check if user must change password (admin reset)
                    if (result.mustChangePassword) {
                        localStorage.setItem('token', result.token);
                        localStorage.setItem('tempUser', JSON.stringify(result.user));
                        showForceChangePasswordModal(result.user.name);
                        return;
                    }
                    
                    // Store token and stayLoggedIn preference
                    localStorage.setItem('token', result.token);
                    localStorage.setItem('user', JSON.stringify(result.user));
                    localStorage.setItem('loginTime', Date.now().toString());
                    if (stayLoggedIn) {
                        localStorage.setItem('stayLoggedIn', 'true');
                    } else {
                        localStorage.removeItem('stayLoggedIn');
                    }
                    
                    // Hide remaining attempts warning on success
                    document.getElementById('remainingAttemptsWarning').style.display = 'none';
                    
                    Swal.fire({
                        title: 'Success!',
                        text: 'Login successful. Redirecting...',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = 'index.html';
                    });
                } else if (result.requiresTwoFactor) {
                    // 2FA is required - show 2FA input section
                    pending2FALogin = {
                        rgno: parseInt(rgno),
                        password: password,
                        stayLoggedIn: stayLoggedIn
                    };
                    showTwoFASection();
                } else {
                    errorDiv.textContent = result.error;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                loadingDiv.style.display = 'none';
                submitBtn.disabled = false;
            }
        }
        
        async function verifyTwoFA() {
            // Check if using backup code or authenticator code
            const isBackupCodeMode = document.getElementById('backupCodeSection').style.display !== 'none';
            let code;
            
            if (isBackupCodeMode) {
                code = getBackupCode();
                if (code.length !== 8) {
                    Swal.fire({
                        title: 'Invalid Backup Code',
                        text: 'Please enter all 8 characters of your backup code',
                        icon: 'warning',
                        confirmButtonColor: '#36ba86'
                    });
                    return;
                }
            } else {
                code = get2FACode();
                if (code.length !== 6) {
                    Swal.fire({
                        title: 'Invalid Code',
                        text: 'Please enter all 6 digits',
                        icon: 'warning',
                        confirmButtonColor: '#36ba86'
                    });
                    return;
                }
            }
            
            const loadingDiv = document.getElementById('twofaLoading');
            const submitBtn = document.getElementById('verifyTwofaBtn');
            const errorDiv = document.getElementById('loginError');
            
            loadingDiv.style.display = 'block';
            submitBtn.disabled = true;
            errorDiv.style.display = 'none';
            
            try {
                // Send login with 2FA code (server detects if it's backup or TOTP by length)
                const response = await fetch(`${AUTH_API}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rgno: pending2FALogin.rgno,
                        password: pending2FALogin.password,
                        twoFactorCode: code,
                        stayLoggedIn: pending2FALogin.stayLoggedIn
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    localStorage.setItem('token', result.token);
                    localStorage.setItem('user', JSON.stringify(result.user));
                    localStorage.setItem('loginTime', Date.now().toString());
                    if (pending2FALogin.stayLoggedIn) {
                        localStorage.setItem('stayLoggedIn', 'true');
                    } else {
                        localStorage.removeItem('stayLoggedIn');
                    }
                    
                    // Show success with special warning if backup code was used
                    if (result.usedBackupCode) {
                        const remaining = result.remainingBackupCodes;
                        const isLow = remaining <= 2;
                        
                        Swal.fire({
                            title: '‚ö†Ô∏è Backup Code Login',
                            html: `
                                <div style="text-align: left;">
                                    <p>You logged in using a backup code.</p>
                                    <div style="background: ${isLow ? '#fff3cd' : '#e8f5e9'}; padding: 12px; border-radius: 8px; margin: 15px 0; border: 1px solid ${isLow ? '#ffc107' : '#4caf50'};">
                                        <strong style="color: ${isLow ? '#856404' : '#2e7d32'};">üìä Remaining codes: ${remaining} of 10</strong>
                                        ${isLow ? '<p style="color: #856404; margin: 8px 0 0; font-size: 14px;">‚ö†Ô∏è Running low! Generate new codes in Settings.</p>' : ''}
                                    </div>
                                    <p style="font-size: 13px; color: #666;">A security notification has been sent to your email.</p>
                                </div>
                            `,
                            icon: 'warning',
                            confirmButtonText: 'Continue',
                            confirmButtonColor: '#36ba86'
                        }).then(() => {
                            window.location.href = 'index.html';
                        });
                    } else {
                        Swal.fire({
                            title: 'Success!',
                            text: 'Login successful. Redirecting...',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            window.location.href = 'index.html';
                        });
                    }
                } else {
                    // Clear inputs and show error
                    if (isBackupCodeMode) {
                        document.querySelectorAll('.backup-digit').forEach(input => {
                            input.value = '';
                            input.classList.remove('filled');
                        });
                        document.querySelector('.backup-digit[data-index="0"]').focus();
                    } else {
                        document.querySelectorAll('.twofa-digit').forEach(input => input.value = '');
                        document.querySelector('.twofa-digit[data-index="0"]').focus();
                    }
                    
                    Swal.fire({
                        title: isBackupCodeMode ? 'Invalid Backup Code' : 'Invalid Code',
                        text: result.error || 'The code you entered is incorrect. Please try again.',
                        icon: 'error',
                        confirmButtonColor: '#36ba86'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to verify code: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#36ba86'
                });
            } finally {
                loadingDiv.style.display = 'none';
                submitBtn.disabled = false;
            }
        }
        
        // Check if already logged in
        window.addEventListener('load', () => {
            const token = localStorage.getItem('token');
            if (token) {
                window.location.href = 'index.html';
            }
            
            // Setup 2FA input handlers
            setup2FAInputs();
            
            // Setup backup code input handlers
            setupBackupCodeInputs();
            
            // Check for logout reason and display popup
            const logoutReason = sessionStorage.getItem('logoutReason');
            if (logoutReason) {
                sessionStorage.removeItem('logoutReason');
                
                Swal.fire({
                    title: 'Logged Out',
                    text: logoutReason,
                    icon: logoutReason.includes('inactivity') ? 'warning' : 'info',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#3498db'
                });
            }
        });
        
        // ==================== FORCE CHANGE PASSWORD (After Admin Reset) ====================
        
        function showForceChangePasswordModal(userName) {
            Swal.fire({
                title: 'üîê Password Change Required',
                html: `
                    <div style="text-align: left; padding: 10px;">
                        <p style="margin-bottom: 20px; color: #666;">
                            Hello <strong>${userName}</strong>, your password was reset by an administrator.
                            <br>You must set a new password to continue.
                        </p>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">New Password</label>
                            <input type="password" id="swal-new-password" class="swal2-input" 
                                   style="width: 100%; margin: 0;" placeholder="Enter new password (min 8 chars)">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Confirm Password</label>
                            <input type="password" id="swal-confirm-password" class="swal2-input" 
                                   style="width: 100%; margin: 0;" placeholder="Confirm new password">
                        </div>
                        <p style="font-size: 12px; color: #888; margin-top: 15px;">
                            <i class="fas fa-info-circle"></i> Choose a strong password that you haven't used before.
                        </p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: false,
                confirmButtonText: 'Change Password',
                confirmButtonColor: '#667eea',
                allowOutsideClick: false,
                allowEscapeKey: false,
                preConfirm: () => {
                    const newPassword = document.getElementById('swal-new-password').value;
                    const confirmPassword = document.getElementById('swal-confirm-password').value;
                    
                    if (!newPassword || !confirmPassword) {
                        Swal.showValidationMessage('Please fill in both password fields');
                        return false;
                    }
                    if (newPassword.length < 8) {
                        Swal.showValidationMessage('Password must be at least 8 characters');
                        return false;
                    }
                    if (newPassword !== confirmPassword) {
                        Swal.showValidationMessage('Passwords do not match');
                        return false;
                    }
                    return { newPassword, confirmPassword };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await submitForceChangePassword(result.value.newPassword, result.value.confirmPassword);
                }
            });
        }
        
        async function submitForceChangePassword(newPassword, confirmPassword) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${AUTH_API}/force-change-password`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ newPassword, confirmPassword })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Merge server response with existing tempUser data (keep full user info)
                    const tempUser = JSON.parse(localStorage.getItem('tempUser') || '{}');
                    const fullUser = { ...tempUser, ...result.user, mustChangePassword: false };
                    localStorage.setItem('user', JSON.stringify(fullUser));
                    localStorage.removeItem('tempUser');
                    localStorage.setItem('loginTime', Date.now().toString());
                    
                    await Swal.fire({
                        title: 'Password Changed!',
                        text: 'Your password has been updated successfully.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    window.location.href = 'index.html';
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: result.error || 'Failed to change password',
                        icon: 'error',
                        confirmButtonColor: '#667eea'
                    }).then(() => {
                        // Show the modal again
                        const tempUser = JSON.parse(localStorage.getItem('tempUser') || '{}');
                        showForceChangePasswordModal(tempUser.name || 'User');
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to change password: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#667eea'
                });
            }
        }
    </script>
</body>
</html>